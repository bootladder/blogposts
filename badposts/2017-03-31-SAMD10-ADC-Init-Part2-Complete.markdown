---
layout: post
title:  "SAMD10 ADC Init, Complete!"
categories:
  - "C/C++"
  - "Embedded"
---

After configuring the GCLK generator and GCLK_ADC, I knew that was done properly because I could
read and write the ADC registers.  I configured the ADC registers but I still could not get a reading.
  
After starting the conversion with a SWTRIG, the RESRDY flag never went high.  
Nothing else indicated a problem.  I then did a similar process as I did to get the GCLKs working:
find working snippets of code that only depends on CMSIS.  
 
Had a theory that if you wait too long after triggering the conversion, the result goes away. 
I found this snippet on avrfreaks.  Looks like it is generated by Atmel START.  

{% highlight c%}
  ADC->SWTRIG.reg = ADC_SWTRIG_START | ADC_SWTRIG_FLUSH;

  /* wait for Synchronization */
  while (ADC->STATUS.reg & ADC_STATUS_SYNCBUSY)
  {
    /* Wait for synchronization */
  }

  while (ADC->INTFLAG.bit.RESRDY == 0)
  {
    /* Wait for analog conversion to complete */
  }

  /* return with converted value */
  return ADC->RESULT.reg;
{% endhighlight %}
  
Pretty obvious but I can't do that with my framework.  So I compiled this and flashed it in the target.
And it works!  
Temp sensor, bandgap ref were both getting results.  
All other register accesses were done over serial, one at a time.  Serial is slow so the delay
between each access was in the milliseconds. 

[jekyll-docs]: https://jekyllrb.com/docs/home
[jekyll-gh]:   https://github.com/jekyll/jekyll
[jekyll-talk]: https://talk.jekyllrb.com/
[wiki-apage]:  /wiki/todo
